<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.oken1.modules.calendar.dao.CalendarEventDao">

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.oken1.modules.calendar.entity.CalendarEventEntity" id="calendarEventMap">
        <result property="id" column="id"/>
        <result property="gameId" column="game_id"/>
        <result property="name" column="name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="platformCode" column="platform_code"/>
        <result property="categoryId" column="category_id"/>
        <result property="imgUrl" column="img_url"/>
        <result property="detailUrl" column="detail_url"/>
        <result property="eventUrl" column="event_url"/>
        <result property="description" column="description"/>
        <result property="tip" column="tip"/>
    </resultMap>

    <resultMap id="EventResultMap" type="io.oken1.modules.calendar.model.EventModel">
        <result property="id" column="id"/>
        <result property="gameId" column="game_id"/>
        <result property="name" column="name"/>
        <result property="gameName" column="game_name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="platformCode" column="platform_code"/>
        <result property="platformName" column="platform_name"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="imgUrl" column="img_url"/>
        <result property="detailUrl" column="detail_url"/>
        <result property="eventUrl" column="event_url"/>
        <result property="description" column="description"/>
        <result property="tip" column="tip"/>
        <collection ofType="java.util.Map" property="rewardList"
                    javaType="java.util.ArrayList">
            <result property="rewardCode" column="reward_code"/>
            <result property="rewardNum" column="reward_num"/>
            <result property="rewardName" column="reward_name"/>
        </collection>
    </resultMap>

    <sql id="baseSql">
        SELECT e.id,
               e.game_id,
               g.name  game_name,
               e.name,
               start_time,
               end_time,
               platform_code,
               p.name  platform_name,
               category_id,
               c.name  category_name,
               img_url,
               detail_url,
               event_url,
               description,
               tip,
               r.reward_code,
               r.reward_num,
               gr.name reward_name
        FROM calendar_event e
                 left join calendar_event_reward r on e.id = r.event_id
                 left join calendar_game_reward gr on r.reward_code = gr.code
                 left join calendar_game g on e.game_id = g.id
                 left join calendar_event_platform p on p.code = e.platform_code
                 left join calendar_event_category c on c.id = e.category_id
    </sql>

    <!--活动列表-->
    <select id="getPageEventList" resultMap="EventResultMap">
        <include refid="baseSql"></include>
        ${ew.customSqlSegment}
        ORDER BY e.end_time DESC
    </select>

    <select id="getEventListByGameIds" resultMap="EventResultMap">
        <include refid="baseSql"></include>
        where 1=1
        and e.END_TIME >= DATE_ADD( CURRENT_time(), INTERVAL -3 DAY )
        <if test="array!= null and array.length >0">
            and e.game_id in
            <foreach collection="array" item="id" index="index" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        ORDER BY e.end_time
    </select>

    <select id="getEventById" resultMap="EventResultMap">
        <include refid="baseSql"></include>
        where 1=1 and e.id = #{id}
    </select>
</mapper>